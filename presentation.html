<!DOCTYPE html>

<!--
  Google HTML5 slide template

  Authors: Luke Mahé (code)
           Marcin Wichary (code and design)

           Dominic Mazzoni (browser compatibility)
           Charles Chen (ChromeVox support)

  URL: http://code.google.com/p/html5slides/
-->

<html>
  <head>
    <title>Presentation</title>

    <meta charset='utf-8'>
    <script
      src='slides.js'></script>
  </head>

  <style>

    .slides.template-bekk > article:not(.nobackground):not(.biglogo) {
      background: url(images/bekk-logo-small.png) 710px 625px no-repeat;
      background-color: white;
    }

    q.small {
      font-size: 1.1em;
    }


  </style>

  <body style='display: none'>

    <section class='slides layout-regular template-bekk'>

      <article>
        <h1>
          Deklarativ konfigurasjonsstyring med Puppet
        </h1>
        <p>
          Ole Christian Rynning og Eivind Uggedal
          <br>
          Bekk Consulting
          <br>
          7. september 2011
        </p>
      </article>
      
      <article style="background: url(images/hands.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 50px;">
          Henda i v&aelig;ret!
        </h1>
        <div class='source'>
          Source: http://flic.kr/p/5Z9g8a
        </div>
      </article>

      <article>
        <q class="question">
            Jobber med drift? (eller devops)
        </q>
      </article>
      
      <article>
        <q class="question">
            Deployer til skyen?
        </q>
      </article>
      
      <article>
        <q class="question">
            Har tilgang til QA?
        </q>
      </article>     
            
      <article>
        <q class="question">
            Har tilgang til produksjon?
        </q>
      </article>

      <article>
        <q class="question">
            Har noen gang sagt det funker <strike>på min maskin</strike>. <strike>QA</strike>. Test?
        </q>
      </article>

      <article>
        <q class="question">
            Har du rot i milj&oslash;ene dine?
        </q>
      </article>
      
      <article>
        <h3>
          Kontinuerlige leveranser
        </h3>
        <ul class="build">
          <li>Raskere og alltid klar til produksjonssetting</li>
          <li>Nedbryting av siloer og bedre kommunikasjon</li>
          <li>Automatisering</li>
          <li>Infrastruktur som kode</li>
        </ul>
      </article>

      <article>
        <h3>
          Infrastruktur som kode
        </h3>
        <ul class="build">
          <li>Dokumentasjon</li>
          <li>Reproduserbarhet</li>
          <li>Homogene miljøer</li>
          <li>Kontinuerlig integrasjon &amp; "ren kode" for drift</li>
        </ul>
      </article>

      <article style="background: #fff url(images/cowboy.jpg) 50px 10px no-repeat;">
        <h1 style="color: #fff; margin-top: 10px; margin-left: 450px; text-align: right;">
          Ingen Cowboy-virksomhet!
        </h1>
        <div class='source'>
          http://flic.kr/p/6cdm8
        </div>
      </article>
      
      <article>
        <h3>
          Bakgrunn
        </h3>
        <h4>
          Ole Christian Rynning
        </h4>
        <div class="build">
        <p>
          Utvikler med erfaring fra drift. Siste par &aring;rene utviklet samt automatisert utrulling og systemarkitektur for Bring utviklingsteam som utvikler <a href="http://beta.bring.no/booking">booking</a>, <a href="http://fraktguide.bring.no">fraktguide</a>, <a href="http://sporing.posten.no">sporing</a> m.fl. og n&aring; ogs&aring; bruker Puppet. 
        </p>
        <h4>
          Eivind Uggedal
        </h4>
        <p>
          Styrer konfigurasjon av rundt 10 servere for blant annet
          <a href="http://mediaqueri.es">mediaqueri.es</a> og
          <a href="http://wasitup.com">wasitup.com</a> samt
          MacBookPro/Air med Puppet.
        </p>
        </div>
      </article>

      <article>
        <h3>
          Deklarativ konfigurasjonsstyring
        </h3>
        <ul class="build">
          <li>
            Deklarativ fremfor imperativ
          </li>
          <li>
            Gjenskape et milj&oslash; fra forskjellige utgangspunkt
          </li>
        </ul>
<div style="width: 55%; float:left; margin-right: 5%;" class="build">
<pre>
apt-get install vim

echo "set nocp" >> /etc/vim/vimrc</pre>
<pre>
yum install vim

echo "set nocp" >> /etc/vim/vimrc</pre>
</div>

<div style="width: 40%; float:left;" class="build">
<pre>
package { "vim":
  ensure => present,
}

file { "/etc/vim/vimrc":
  content => "set nocp",
}</pre>
</div>

      </article>

      <article>
        <h3>
          Deklarative konfigurasjonsverkt&oslash;y
        </h3>
        <ul class="build">
          <li>
            CFEngine (1993)
            <ul>
              <li>
                F&oslash;rste deklarative konfigurasjonsverkt&oslash;y
              </li>
              <li>
                Lav-niv&aring;
              </li>
            </ul>
          </li>
          <li>
            Puppet (2005)
            <ul>
              <li>
                Skriver &oslash;nsket konfigurasjon i eget DSL
              </li>
              <li>
                Lettvekt. Ingen avhengigheter for Puppet server.
              </li>
            </ul>
          </li>
          <li>
            Chef (2008)
            <ul>
              <li>
                En del tyngre. Krever CouchDB, Solr, RabbitMQ for
                Chef server.
              </li>
              <li>
                Skriver &oslash;nsket konfigurasjon i Ruby
              </li>              
            </ul>
          </li>
        </ul>
      </article>

      <article style="background: url(images/puppets.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 50px;">
          Puppet
        </h1>
        <div class='source'>
          Source: http://flic.kr/p/6qy7W2
        </div>
      </article>

      <article>
        <h3>
          Puppet arkitektur
        </h3>
        <ul class='build'>
          <li>
            Frittst&aring;ende
          </li>
          <li>
            Klient/Server
          </li>
        </ul>
        <div class='build'>
        <dl>
          <dt>
          Kj&oslash;rer p&aring;:
          </dt>
          <dd>
          Linux (Debian, Ubuntu, RHEL, Gentoo, et. al.)
          </dd>
          <dd>
          BSD (FreeBSD, OpenBSD, NetBSD)
          </dd>
          <dd>
          OS X
          </dd>
          <dd>
          Solaris, AIX, HP-UX
          </dd>
          <dd>
          Windows (ekstremt eksperimentell)
          </dd>
        </dl>
        </div>
      </article>
      
      <article style="background: #fff url(images/building_blocks.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 10px; margin-left: 450px; text-align: right;">
          Byggstener
        </h1>
        <div class='source'>
          http://flic.kr/p/5zjAdT
        </div>
      </article>
      

      <article>
        <h3>Ressurser</h3>
        <p>
          Har <code>type</code>, <code>navn</code> og <code>parametere</code>
        </p>
        <section>
<pre>
package { "zsh":
  ensure => present,
}</pre>
        </section>
      </article>

      <article>
        <h3>Frittstående bruk</h3>
        <section>
          <pre>apt-get install puppet</pre>
        </section>
        <section>
          <pre>
# zsh.pp
package { "zsh":
  ensure => present,
}</pre>
        </section>
        <section>
          <pre>
puppet apply zsh.pp</pre>
        </section>
      </article>

      <article>
        <h3>Ulike ressurstyper</h3>
        <section>
        <pre>
user { "oc":
  ensure     => present,
  uid        => 1337,
  home       => "/home/oc",
  managehome => true,
  password   => '$6$xSZZx34H$7Wv2cIRg/MP2BGGp64OOmjxL6vxfl2QxNsmsRylxWsyA4maIp20lot3rw76Bl75DXfqltqDQUwNNWmHSTlEuJ/',
}

cron { "poor-mans-http-ping":
  command => "curl -s http://wasitup.com/ > /dev/null 2>&amp;1",
  minute  => "*/1", # Sjekk hvert minutt
}</pre>
        </section>
      </article>

      <article>
        <h3>Generiske ressurstyper</h3>
        <p>
          Byggestener for å beskrive ressurser som ikke er
          innebygd i Puppet.
        </p>
        <section>
          <pre>
file { "/etc/timezone":
  content => "Europe/Oslo\n",
}

exec { "reconfigure-tzdata":
  command => "/usr/sbin/dpkg-reconfigure -f noninteractive tzdata",
}</pre>
        </section>
      </article>

      <article>
        <h3>Avhengigheter mellom ressurser</h3>
        <p><code>require</code> / <code>before</code> og <code>notify</code> / <code>subscribe</code>
        <section>
          <pre>
file { "/etc/timezone":
  content => "Europe/Oslo\n",
}

exec { "reconfigure-tzdata":
  command => "/usr/sbin/dpkg-reconfigure -f noninteractive tzdata",
  require => File["/etc/timezone"],
}</pre>

          <pre>
File["/etc/timezone"] ->  Exec["reconfigure-tzdata"] # require
        </section>
      </article>

      <article>
        <h3>Templater og variabler</h3>
        <section>
          <pre>
$port = 22
$allowed_users = ["eivind", "oc"] # Tillat innlogging

package { "openssh-server":
  ensure => present,
}

file { "/etc/ssh/sshd_config":
  content => template("sshd_config.erb"),
  require => Package["openssh-server"],
}

service { ssh:
  ensure    => running,
  hasstatus => true,
  subscribe => [Package["openssh-server"],
                File["/etc/ssh/sshd_config"]],
}</pre>
        </section>
      </article>
      <article>
        <h3>templates/sshd_config.erb</h3>
        <section>
<pre>
Port &lt;%= port %&gt;

Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key
UsePrivilegeSeparation yes

StrictModes yes
PubkeyAuthentication yes
PermitRootLogin no

&lt;% if allowed_users.any? %&gt;
AllowUsers &lt;%= allowed_users.join(" ") %&gt;
&lt;% end %&gt;

...
</pre>
        </section>
      </article>

      <article>
        <h3>Kjør kode med templates</h3>
        <section>
          <pre>puppet apply --templatedir=templates templates.pp</pre>
        </section>
      </article>

      <article>
        <h3>Klasser: samlinger av ressurser (singleton).</h3>
        <section>
          <pre>
class nginx {
  package { nginx:
    ensure => present,
  }
  file { "/etc/nginx/nginx.conf":
    source  => "puppet:///modules/nginx/nginx.conf",
    require => Package[nginx],
  }
  service { nginx:
    ensure    => running,
    enable    => true,
    pattern   => "nginx: master process",
    subscribe => File["/etc/nginx/nginx.conf"],
    require   => File["/etc/nginx/nginx.conf"],
  }
}</pre>
        </section>
      </article>

      <article>
        <h3>Moduler</h3>
        <p>Den foretrukne m&aring;ten &aring; strukturere konfigurasjon på er å plassere det i moduler.</p>
        <section>
<pre>
modules/
    nginx/
      manifests/
        init.pp
      files/
        nginx.conf
      templates/
        site.conf.erb
    jvm/
      manifests/
        init.pp
        jdk.pp
        jetty.pp
</pre>
        </section>
      </article>

      <article>
        <h3>Bruk av klasser</h3>
        <section>
          <pre>include nginx</pre>
        </section>

        <h3>Kjør kode med moduler</h3>
        <section>
          <pre>puppet apply --modulepath=modules nginx.pp</pre>
        </section>
      </article>

      <article>
        <h3>Bruk av egendefinerte ressurstyper</h3>
        <section>
<pre>jvm::jetty { "sporing":
  port   => 9000, 
  secret => "31d83902b0408579c2b974cc3274aabf",
}</pre>

<pre>jvm::jetty { "booking": 
  port   => 9001, 
  secret => "2f0cb27e5c27729396066b60e0f242ed",
}</pre>
        </section>
      </article>


      <article>
        <h3>Opprette egne ressurstyper med define</h3>
        <section>
<pre>define jvm::jetty($secret,
                  $port,
                  $ensure=present,
                  $context_path="/",
                  $prefix="/var/apps",
                  $owner="deploy",
                  $group="users",   
                  $run_prefix="/var/run",
                  $log_prefix="/var/log",
                  $cache_prefix="/var/cache",
                  $jvm_args=[]) {

  $appdir="${prefix}/${name}"
  $workdir="${cache_prefix}/${name}"
  $logdir="${log_prefix}/${name}"
  $pidfile="${run_prefix}/${name}.pid"

  #...</pre>
        </section>
      </article>

      <article>
        <h3>Opprette egne ressurstyper med define (forts.)</h3>
        <section>
<pre>if $ensure == 'present' {
  file { $prefix:
    ensure => directory,
  }  

  # ...
  
  file { "/etc/init.d/${name}":
    ensure => present,
    content => template("jvm/jetty.sh.erb"),
    notify => Service["${name}"],
    owner => root,
    group => root,
    mode   => '0755',
  }  
  
</pre>
        </section>
      </article>


      <article>
        <h3>Sammendrag av Puppet DSL</h3>

        <ul>
          <li>
            Innebygde ressurstyper
            <ul>
              <li>
                <code>package</code>,
                <code>user</code>,
                <code>cron</code>,
                <code>service</code>,
                <code>file</code> og
                <code>exec</code>.
              </li>
            </ul>
          </li>
          <li>
            Avhengighter
            <ul>
              <li>
                <code>require</code>,
                <code>before</code>,
                <code>subscribe</code> og
                <code>notify</code>.
              </li>
            </ul>
          </li>
          <li>
            Innebygde funksjoner
            <ul>
              <li>
                <code>template()</code>
              </li>
            </ul>
          </li>
          <li>Klasser (<code>class</code>)</li>
          <li>Egendefinerte ressurstyper (<code>define</code>)</li>
        </ul>
      </article>

      <article>
        <h3>Mer Puppet DSL</h3>

        <ul>
          <li>
            Innebygde ressurstyper
            <ul>
              <li>
                <code>host</code>,
                <code>mount</code>,
                <code>ssh_authorized_key</code> og
                <code>sshkey</code>.
              </li>
            </ul>
          </li>
          <li>
            Innebygde funksjoner
            <ul>
              <li>
                <code>inline_template()</code>,
                <code>file()</code>,
                <code>regsubst()</code>,
                <code>split()</code> og
                <code>versioncmp()</code>.
              </li>
            </ul>
          </li>
          <li>Arrays (<code>["en", "to"]</code>)</li>
          <li>Hashes (<code>{"n&oslash;kkel" => "verdi", "a" => "b"}</code>)</li>
          <li>
            Flytkontroll (<code>case</code> og
            <code>if/elsif/else</code>)
          </li>
          <li>Virtuelle ressurser (<code>@ressurs { "navn": }</code>)</li>
          <li>Eksporterte ressurser (<code>@@ressurs { "navn": }</code>)</li>
        </ul>
      </article>

      <article>
        <h3>Klient / Server (puppet agent / puppet master)</h3>
        <ul>
          <li>Én Puppet-master (server)</li>
          <li>Mange Puppet-agenter (klienter) som henter konfigurasjon fra master over et REST API</li>
          <li>SSL-sertifikatbasert autentisering. Agenter må signeres/godkjennes av Master</li>
        </ul>
      </article>

      <article>
        <h3>Typisk klient / server oppsett</h3>
        <section>
          <img src="images/puppet-arch.png">
        </section>
      </article>

      <article>
        <h3>manifests/nodes.pp</h3>
        <section>
          <pre>
node webserver {
  include nginx
  nginx::site { "muda":
    domain => "www.muda.no",
    root => "/var/www/muda.no",
  }
}
node appserver {
  include java
  jvm::jetty { "example":
    secret => "fe9dee1f3a0c22dfff0aec9838f7e70e",
    port => 9000,
  }
}
node "web1.muda.no" inherits webserver
node "app1.muda.no" inherits appserver
node "app2.muda.no" inherits appserver
</pre>
        </section>
      </article>

      <article style="background: url(images/juggler.jpg) 0 0 no-repeat;">
        <h1 style="color: #fff; margin-top: 50px;">
          Demo
        </h1>
        <div class='source'>
          Source: http://flic.kr/p/2fiWvK
        </div>
      </article>
      
      <article>
        <h1>
          Behov: en applikasjon for å håndtere RSVPs for ymse arrangementer
        </h1>
        <p>
          * Applikasjon: Play MVC, jetty-pkg, PostgreSQL.
          * 3 servere: 
            - mgmt (master, nexus, ...)
            - web1 (nginx)
            - app1 (jetty exec)          
        </p>
      </article>
      
      <article>
        <h1>
          Bootstrappe mgmt
        </h1>
        <p>
          * Har installert puppetmaster og git
          * Ingen java og ingen nexus
          * Bootstrap
          * java &amp; nexus -> kan bygge og deploye demo
        </p>
      </article>

      <article>
        <h1>
          Bootstrappe web1
        </h1>
        <p>
          * Har allerede installert puppet
          * cert request
          * godkjenne cert
          * Ingen webserver 
          * Bootstrap
          * Webserver, bad gateway..
        </p>
      </article>

      <article>
        <p>Agenter har ikke tilgang til kildekoden for konfigurasjonen:</p>
        <ol>
          <li>Agent identifiserer seg og forespør en konfigurasjonskatalog fra master</li>
          <li>Master kompilerer en oppdatert konfigurasjonskatalog og sender til agent</li>
          <li>Agent pakker opp konfigurasjonskatalogen som ender opp i kjørbar konfigurasjon</li>
        </ol>
      </article>
      
      <article>
        <h1>
          Bootstrappe app1
        </h1>
        <p>
          * Har allerede installert puppet
          * Ingen java 
          * Bootstrap
          * deploy app (pull fra nexus)
          * Vis applikasjon, lag event, registrer to deltakere                    
        </p>
      </article>
      
      <!--
      <article>
        <h3>
          Debugging av Puppet
        </h3>
        <p>
          Start master med:
          <pre><code>puppet master --no-deamonize</pre></code>
          Start agenter med:
          <pre><code>puppet --debug --verbose file.pp
puppet --parseonly file.pp</pre></code>
          Log fra manifest filer:
<pre><code>notice("The value is: ${yourvar}")   # Log til master
notify{"The value is: ${yourvar}": } # Log til klient</pre></code>

        </p>
      </article>
      -->

      <article>
        <h1>
          Slides og kode
        </h1>
        <p>
          <a href="https://github.com/bekkopen/jz11-puppet">
            github.com/bekkopen/jz11-puppet
          </a>
        </p>
      </article>

      <article style="background: url(images/question.jpg) 0 0 no-repeat;">
        <div class='source'>
          Source: http://flic.kr/p/ubG6g
        </div>
      </article>

  </body>
</html>
